#!/usr/bin/env bash 

# remove tmp's leftover from a bad shutdown
rm -f /tmp/mongodb-27017.sock

DATABASE_PATH="$(node -e 'console.log(require("./package.json").parameters.databaseSetup.databasePath)')"
mkdir -p "$DATABASE_PATH"

LOG_FILE_PATH="$(node -e 'console.log(require("./package.json").parameters.paths.serverLog)')"

mkdir -p "$(dirname "$LOG_FILE_PATH")"
{
    # if it fails try repairing it (the or statement)
    pm2 start mongod --log "$LOG_FILE_PATH" -- --bind_ip 127.0.0.1 --dbpath "$DATABASE_PATH" || pm2 start mongod --log "$LOG_FILE_PATH" -- --repair --bind_ip 127.0.0.1
} > "$LOG_FILE_PATH" 2>&1 &

echo "logs sent to: $LOG_FILE_PATH"